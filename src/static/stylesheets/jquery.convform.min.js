function SingleConvState(t){return this.input=t,this.next=!1,this}function ConvState(t,e,r){this.form=r,this.wrapper=t,this.current=e,this.answers={},this.scrollDown=function(){$(this.wrapper).find("#messages").stop().animate({scrollTop:$(this.wrapper).find("#messages")[0].scrollHeight},600)}.bind(this)}SingleConvState.prototype.hasNext=function(){return this.next},ConvState.prototype.next=function(){if(this.current.hasNext()){if(this.current=this.current.next,this.current.input.hasOwnProperty("fork")&&this.current.input.hasOwnProperty("case")){if(this.answers.hasOwnProperty(this.current.input.fork)&&this.answers[this.current.input.fork].value!=this.current.input["case"])return this.next();if(!this.answers.hasOwnProperty(this.current.input.fork))return this.next()}return!0}return!1},ConvState.prototype.printQuestion=function(){var t=this.current.input.questions,e=t[Math.floor(Math.random()*t.length)],r=e.match(/\{(.*?)\}(\:(\d)*)?/g);for(var n in r)if(r.hasOwnProperty(n)){var i=r[n].replace(/\{|\}/g,""),s=i,a=!1;if(-1!=i.indexOf(":")&&(s=s.split(":")[0],a=i.split(":")[1]),a!==!1){var p=this.answers[s].text.split(" ");e=p.length>=a?e.replace(r[n],p[a]):e.replace(r[n],this.answers[s].text)}else e=e.replace(r[n],this.answers[s].text)}var u=$('<div class="message to typing"><div class="typing_loader"></div></div>');setTimeout(function(){$(this.wrapper).find("#messages").append(u),this.scrollDown()}.bind(this),100),setTimeout(function(){u.html(e),u.removeClass("typing").addClass("ready"),"select"==this.current.input.type&&this.printAnswers(this.current.input.answers,this.current.input.multiple),this.scrollDown(),this.current.input.hasOwnProperty("noAnswer")&&(this.next(),setTimeout(function(){this.printQuestion()}.bind(this),200)),$(this.wrapper).find("#userInput").focus()}.bind(this),500)},ConvState.prototype.printAnswers=function(t,e){if(this.wrapper.find("div.options div.option").remove(),e){for(var r in t)if(t.hasOwnProperty(r)){var n=$('<div class="option">'+t[r].text+"</div>").data("answer",t[r]).click(function(t){var e=this.current.input.selected.indexOf($(t.target).data("answer").value);-1==e?(this.current.input.selected.push($(t.target).data("answer").value),$(t.target).addClass("selected")):(this.current.input.selected.splice(e,1),$(t.target).removeClass("selected")),this.current.input.selected.length>0?this.wrapper.find("button.submit").addClass("glow"):this.wrapper.find("button.submit").removeClass("glow")}.bind(this));this.wrapper.find("div.options").append(n),$(window).trigger("dragreset")}}else for(var r in t)if(t.hasOwnProperty(r)){var n=$('<div class="option">'+t[r].text+"</div>").data("answer",t[r]).click(function(t){this.current.input.selected=$(t.target).data("answer").value,this.answerWith($(t.target).data("answer").text,$(t.target).data("answer")),this.wrapper.find("div.options div.option").remove()}.bind(this));if(t[r].hasOwnProperty("callback")){var i=t[r].callback;n.click(function(t){window[this]()}.bind(i))}this.wrapper.find("div.options").append(n),$(window).trigger("dragreset")}var s=$(this.wrapper).find("div.options").height();$(this.wrapper).find("#messages").css({paddingBottom:s})},ConvState.prototype.answerWith=function(t,e){this.current.input.hasOwnProperty("name")&&("string"==typeof e?("tel"==this.current.input.type&&(e=e.replace(/\s|\(|\)|-/g,"")),this.answers[this.current.input.name]={text:t,value:e},console.log("previous answer: ",e)):this.answers[this.current.input.name]=e,"select"!=this.current.input.type||this.current.input.multiple?$(this.current.input.element).val(e).change():$(this.current.input.element).val(e.value).change()),"password"==this.current.input.type&&(t=t.replace(/./g,"*"));var r=$('<div class="message from">'+t+"</div>");$(this.wrapper).find("div.options div.option").remove();var n=$(this.wrapper).find("div.options").height();$(this.wrapper).find("#messages").css({paddingBottom:n}),$(this.wrapper).find("#userInput").focus(),setTimeout(function(){$(this.wrapper).find("#messages").append(r),this.scrollDown()}.bind(this),300),$(this.form).append(this.current.input.element),this.next()?setTimeout(function(){this.printQuestion()}.bind(this),300):this.form.submit()},function(t){t.fn.convform=function(e){var r=this,n=t(this).find("input, select, textarea").map(function(){var e={};return t(this).attr("name")&&(e.name=t(this).attr("name").replace(/\[|\]/g,"")),t(this).attr("no-answer")&&(e.noAnswer=!0),t(this).attr("type")&&(e.type=t(this).attr("type")),e.questions=t(this).attr("conv-question").split("|"),t(this).attr("pattern")&&(e.pattern=t(this).attr("pattern")),t(this).is("select")&&(e.type="select",e.answers=t(this).find("option").map(function(){var e={};return e.text=t(this).text(),e.value=t(this).val(),t(this).attr("callback")&&(e.callback=t(this).attr("callback")),e}).get(),t(this).prop("multiple")?(e.multiple=!0,e.selected=[]):(e.multiple=!1,e.selected="")),t(this).parent("div[conv-case]").length&&(e["case"]=t(this).parent("div[conv-case]").attr("conv-case"),e.fork=t(this).parent("div[conv-case]").parent("div[conv-fork]").attr("conv-fork")),e.element=this,t(this).detach(),e}).get(),i=t(r).find("form").hide(),s=t('<form id="convForm"><div class="options dragscroll"></div><textarea id="userInput" rows="1" placeholder="'+e+'"></textarea><button type="submit" class="icon2-arrow submit">â¯ˆ</button><span class="clear"></span></form>');t(r).append('<div class="wrapper-messages"><div id="messages"></div></div>'),t(r).append(s);var a=new SingleConvState(n[0]),p=new ConvState(r,a,i);for(var u in n)0!=u&&n.hasOwnProperty(u)&&(a.next=new SingleConvState(n[u]),a=a.next);return p.printQuestion(),t(s).find("#userInput").keypress(function(e){if(13==e.which){var r=t(this).val();if(e.preventDefault(),"select"!=p.current.input.type||p.current.input.multiple)if("select"==p.current.input.type&&p.current.input.multiple)if(""!=r.trim()){var n=p.current.input.answers.filter(function(t){return-1!=t.text.toLowerCase().indexOf(r.toLowerCase())});n.length?-1==p.current.input.selected.indexOf(n[0].value)?(p.current.input.selected.push(n[0].value),p.wrapper.find("#userInput").val("")):p.wrapper.find("#userInput").val(""):p.wrapper.find("#userInput").addClass("error")}else p.current.input.selected.length&&t(this).parent("form").submit();else""==r.trim()||p.wrapper.find("#userInput").hasClass("error")?t(p.wrapper).find("#userInput").focus():t(this).parent("form").submit();else{var n=p.current.input.answers.filter(function(t){return-1!=t.text.toLowerCase().indexOf(r.toLowerCase())});n.length?(p.current.input.selected=n[0],t(this).parent("form").submit()):p.wrapper.find("#userInput").addClass("error")}}autosize.update(t(p.wrapper).find("#userInput"))}).on("input",function(e){if("select"==p.current.input.type){var r=t(this).val(),n=p.current.input.answers.filter(function(t){return-1!=t.text.toLowerCase().indexOf(r.toLowerCase())});n.length?(p.wrapper.find("#userInput").removeClass("error"),p.printAnswers(n,p.current.input.multiple)):p.wrapper.find("#userInput").addClass("error")}else if(p.current.input.hasOwnProperty("pattern")){var i=new RegExp(p.current.input.pattern,"i");i.test(t(this).val())?p.wrapper.find("#userInput").removeClass("error"):p.wrapper.find("#userInput").addClass("error")}}),t(s).find("button.submit").click(function(e){var r=t(p.wrapper).find("#userInput").val();if(e.preventDefault(),"select"!=p.current.input.type||p.current.input.multiple)if("select"==p.current.input.type&&p.current.input.multiple)if(""!=r.trim()&&"Escreva aqui..."!=r){var n=p.current.input.answers.filter(function(t){return-1!=t.text.toLowerCase().indexOf(r.toLowerCase())});n.length?-1==p.current.input.selected.indexOf(n[0].value)?(p.current.input.selected.push(n[0].value),p.wrapper.find("#userInput").val("")):p.wrapper.find("#userInput").val(""):p.wrapper.find("#userInput").addClass("error")}else p.current.input.selected.length&&(t(this).removeClass("glow"),t(this).parent("form").submit());else""==r.trim()||p.wrapper.find("#userInput").hasClass("error")?t(p.wrapper).find("#userInput").focus():t(this).parent("form").submit();else{"Escreva aqui..."==r&&(r="");var n=p.current.input.answers.filter(function(t){return-1!=t.text.toLowerCase().indexOf(r.toLowerCase())});n.length?(p.current.input.selected=n[0],t(this).parent("form").submit()):p.wrapper.find("#userInput").addClass("error")}autosize.update(t(p.wrapper).find("#userInput"))}),t(s).submit(function(e){e.preventDefault();var r=t(this).find("#userInput").val();t(this).find("#userInput").val(""),"select"==p.current.input.type?p.current.input.multiple?p.answerWith(p.current.input.selected.join(", "),p.current.input.selected):p.answerWith(p.current.input.selected.text,p.current.input.selected):p.answerWith(r,r)}),"function"==typeof autosize&&($textarea=t(p.wrapper).find("#userInput"),autosize($textarea)),p}}(jQuery),$(function(){$(".conv-form-wrapper").convform("Write here...")});